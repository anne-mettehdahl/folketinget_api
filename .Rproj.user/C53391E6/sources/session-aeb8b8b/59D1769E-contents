hent_opdateret_moedefiler <- function(since = Sys.Date() - 1) {
  since <- as.POSIXct(since, tz = "CET")
  
  list_url = "ftp://oda.ft.dk/ODAXML/Referat/samling/"
  list_raw <- tryCatch({
    getURL(list_url, ftp.use.epsv = FALSE, dirlistonly = FALSE)
  }, error = function(e) {
    stop("Could not retrieve list", e$message)
  })
  
  lines <- strsplit(list_raw, "\n")[[1]]
  print(head(lines))
  folders <- str_match(lines, "\\s+(\\d{5})$")[,2]
  print(folders)
  folders <- na.omit(folders)
  
  result <- list()
  
  for (sid in folders) {
    message("Checking samling", sid)
    files <- hent_moeder(sid, only_files = TRUE)
    
    if (nrow(files) == 0) next
    
    newer_files <- files %>% 
      filter(last_updated > since)
    if (nrow(newer_files) == 0) next
    
    message(sprintf(" - %d updated files found since %s", nrow(newer_files), since))
    
    base_url <- paste0(list_url, sid, "/")
    
    pb <- progress_bar$new(
      format = sprintf(" Samling %s [:bar] :current/:total (:percent)", sid),
      total = nrow(newer_files), clear = FALSE, width = 60
    )
    
    df_list <- lapply(seq_len(nrow(newer_files)), function(j) {
      pb$tick()
      filename <- newer_files$filename[j]
      last_updated <- newer_files$last_updated[j]
      full_url <- paste0(base_url, filename)
      
      tryCatch({
        df <- parse_meeting_xml(full_url)
        df$last_updated <- last_updated
        df$samling_id <- sid
        return(df)
      }, error = function(e) {
        message(sprintf("Skipping file '%s': %s", filename, e$message))
        return(NULL)
      })
    })
    
    df_list <- Filter(Negate(is.null), df_list)
    if (length(df_list) > 0) {
      result[[sid]] <- bind_rows(df_list)
    }
  }
  
  if (length(result) == 0) {
    message("No updated files found since")
    return(NULL)
  }
  final_result <- bind_rows(result)
  final_result <- final_result %>% 
    # mutate(meetingnr = as.numeric(meetingnr)) %>% 
    group_by(samling_id) %>%
    arrange(meetingnr, .by_group = TRUE)
  return(final_result)
}
