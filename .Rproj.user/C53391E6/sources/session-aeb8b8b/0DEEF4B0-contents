library(xml2)
library(tibble)
library(purrr)
library(stringr)

safe_xml_text <- function(node, xpath) {
  res <- xml_find_first(node, xpath)
  if (inherits(res, "xml_missing") || is.na(res)) return(NA_character_)
  xml_text(res)
}

parse_meeting_xml <- function(xml_input) {
  ft_xml <- if (is.character(xml_input)) read_xml(xml_input) else xml_input
  meetingnr <- safe_xml_text(ft_xml, ".//MeetingNumber")
  date_of_sitting <- safe_xml_text(ft_xml, ".//DateOfSitting")
  agenda_points <- xml_find_all(ft_xml, ".//DagsordenPunkt")
  
  map_dfr(agenda_points, function(punkt) {
    speeches <- xml_find_all(punkt, ".//Tale")
    map_dfr(speeches, function(tale) {
      tibble(
        meetingnr = meetingnr,
        date_of_sitting = date_of_sitting,
        itemNum = safe_xml_text(punkt, ".//ItemNo"),
        title = safe_xml_text(punkt, ".//ShortTitle"),
        full_name = paste(trimws(safe_xml_text(tale, ".//OratorFirstName")),
                          trimws(safe_xml_text(tale, ".//OratorLastName"))),
        group = safe_xml_text(tale, ".//GroupNameShort"),
        tale_text = xml_text(tale),
        start_time = safe_xml_text(tale, ".//StartDateTime"),
        end_time = safe_xml_text(tale, ".//EndDateTime"),
        rolle = safe_xml_text(tale, ".//TalerTitel")
      )
    })
  })
}
